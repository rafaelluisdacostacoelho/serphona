You are a senior backend engineer with strong focus on testing and security for payment systems.

For the “Serphona Payments Service”, I need a test and security strategy.

Requirements:
- Unit tests for:
  - domain logic (subscriptions, wallet, events)
  - adapters (Stripe mocks, repository mocks).
- Integration tests for:
  - database interactions
  - Stripe webhook processing (using fake payloads).
- End-to-end tests for:
  - “tenant subscribes to plan and gets roles”
  - “tenant tops up wallet and consumes credits”.

Security concerns:
- Secrets management (Stripe API keys, webhook secrets, DB secrets).
- HTTPS everywhere (in production).
- Input validation and safe JSON handling.
- Rate limiting for sensitive endpoints (e.g., wallet operations).
- Proper logging of security-relevant events.

Please:

1. Propose a testing strategy:
   - test layout in Go
   - how to structure tests per package/layer
   - how to mock Stripe and message broker
   - how to use Docker Compose or test containers for PostgreSQL in integration tests.

2. Provide examples of:
   - a unit test for wallet consumption preventing negative balance
   - a unit test for subscription events triggering role-related events.

3. Outline security best practices for this service:
   - secret storage approach
   - validation and sanitization of inputs (including webhooks)
   - least privilege for DB and Stripe keys
   - logging without leaking sensitive data.

4. Suggest a minimal checklist to run before going to production for this payments service.
